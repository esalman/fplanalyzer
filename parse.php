<?php
// debug mode
// ini_set('display_errors', false);
// error_reporting(E_ALL^E_WARNING^E_NOTICE);
ini_set('display_errors', false);
error_reporting(E_ALL^E_WARNING^E_NOTICE);

header('Access-Control-Allow-Origin: http://fantasy.premierleague.com');

// anonymous tracking
// measurement protocol
$post = array(
	'v' => 1,
	'tid' => 'UA-42877953-1',
	'cid' => isset( $_REQUEST['cid'] ) ? '201415'.$_REQUEST['cid'] : null,
	't' => 'pageview',
	'dh' => 'fplanalyzer.com',
	'dp' => '/parse.php',
	'dt' => 'Parser',
	'uip' => $_SERVER['REMOTE_ADDR'],
	'ua' => $_SERVER['HTTP_USER_AGENT'],
	'dr' => $_SERVER['HTTP_REFERER'],
);

$request = 'https://ssl.google-analytics.com/collect';
$request .= '?payload_data&';
$request .= http_build_query($post);
$result = file_get_contents( $request );

// parsing player data
// p = price
// n = number of owners
// c = NTI percent
// d = NTI today

$arr = array();
$predictor = isset( $_REQUEST['p'] ) ? $_REQUEST['p'] : 'CTC';
switch( $predictor ) {
	case 'TFPL':
		$url = 'http://totalfpl.com/pricechanges/';
		$content = file_get_contents($url);
		$start = strpos($content, 'var pricedata =')+16;
		$end = strpos($content, 'var eventdata =')-4;
		$str = substr($content, $start, $end-$start);
		$data = json_decode($str);

		// map creating code
		// $url = 'http://crackthecode.fiso.co.uk/blog/';
		// $content = file_get_contents($url);
		// $map = array();
		// foreach( $data as $k => $player ) {
		// 	$name = explode(',', $player->Nam);
		// 	$start = strpos( $content, trim( $name[1].' '.$name[0] ) );
		// 	if ( ! $start ) {
		// 		echo $player->Id.': '.$player->Nam.$player->Tem."\t".'NOT FOUND'.'<br />';
		// 		continue;
		// 	}
		// 	$str = substr($content, $start-6, 6).'<br />';
		// 	echo $k.': '.$player->Nam."\t".filter_var($str, FILTER_SANITIZE_NUMBER_INT).'<br />';
		// 	$map[ $player->Id ] = filter_var($str, FILTER_SANITIZE_NUMBER_INT);
		// }
		// echo json_encode($map);
		// exit();

		// tfpl -> fpl
		// no match
		// "1461":"522","1453":"471","1428":"252","1436":"317","1216":"250","1247":"498","227":"261","1232":"433","1445":"405","1368":"223","1254":"221","1438":"323","1289":"94","1422":"205","1245":"382","1426":"246"
		$map = json_decode('{"34":"2","1172":"91","313":"12","880":"381","1405":"100","1222":"342","1480":"548","927":"152","307":"539","344":"430","177":"431","480":"237","513":"53","1337":"149","1056":"364","1276":"496","473":"81","487":"245","1194":"155","1196":"158","619":"253","1441":"356","244":"368","910":"217","1027":"351","1418":"192","1097":"295","427":"216","373":"146","431":"30","208":"284","136":"197","81":"236","404":"460","1402":"78","402":"500","1241":"472","267":"547","1324":"388","429":"366","1464":"525","1429":"254","1470":"532","736":"449","312":"448","233":"231","1478":"545","1362":"172","341":"260","1237":"457","1224":"353","44":"288","1281":"298","864":"393","676":"207","99":"29","1465":"526","975":"349","495":"233","1203":"164","1442":"362","1398":"69","151":"378","483":"39","1475":"541","97":"495","741":"452","1007":"34","356":"392","363":"489","451":"95","104":"10","1390":"60","1052":"343","135":"309","1198":"159","1264":"279","663":"84","1293":"241","1035":"82","1280":"385","148":"99","416":"41","396":"40","286":"292","460":"201","567":"400","1389":"59","1437":"318","1468":"530","851":"289","367":"215","113":"507","289":"51","1182":"114","803":"319","1408":"179","1399":"71","114":"325","156":"484","737":"450","146":"169","1458":"514","1434":"313","1472":"537","1456":"506","405":"67","337":"300","1066":"456","362":"163","1364":"125","1278":"121","1416":"190","913":"49","1230":"427","801":"5","187":"574","281":"580","315":"490","529":"555","800":"560","826":"571","961":"577","1249":"583","1283":"558","1344":"561","1485":"556","1486":"557","1487":"559","1488":"562","1489":"563","1490":"564","1491":"565","1492":"566","1493":"567","1494":"568","1495":"569","1496":"570","1497":"572","1498":"573","1499":"575","1500":"576","1501":"578","1502":"579","1503":"581","1504":"582","1505":"584","507":"501","756":"479","1016":"307","1211":"228","1255":"120","1383":"390","419":"273","666":"487","890":"88","1185":"117","682":"305","1170":"86","1404":"98","1258":"384","1394":"64","1417":"191","1463":"524","937":"306","1187":"126","1303":"55","492":"50","1356":"445","986":"371","1183":"115","1268":"177","1199":"160","720":"326","1388":"58","1240":"466","1309":"123","630":"102","909":"47","1298":"109","849":"379","1334":"38","1380":"150","1132":"93","1377":"469","1381":"97","1483":"553","219":"409","335":"488","1333":"222","1361":"475","933":"276","1263":"27","1320":"355","1060":"142","1084":"473","1455":"485","867":"304","998":"338","745":"461","1284":"436","228":"269","1119":"7","1110":"131","1129":"413","1207":"175","1378":"438","272":"118","1443":"376","934":"277","1094":"141","1375":"389","664":"208","972":"188","515":"113","1411":"182","1396":"66","915":"494","269":"271","1452":"470","866":"373","982":"414","1138":"442","1285":"19","1450":"459","1350":"96","991":"509","1261":"346","1313":"111","1286":"519","932":"278","1262":"354","1413":"184","410":"74","1384":"287","1315":"8","591":"48","1351":"140","559":"333","1372":"482","842":"206","1149":"37","1316":"56","417":"293","1462":"523","1424":"225","1104":"432","617":"303","1041":"35","580":"85","1373":"415","860":"154","36":"166","328":"167","1048":"359","752":"128","1151":"46","1432":"299","271":"290","285":"327","1482":"550","901":"76","746":"251","1173":"92","1251":"108","1391":"61","1403":"83","433":"492","627":"258","995":"518","1326":"213","400":"156","1297":"122","1114":"297","1294":"372","1401":"75","1059":"239","378":"324","372":"105","585":"136","1317":"361","990":"503","847":"535","1071":"18","1352":"316","1226":"402","1397":"68","1374":"9","1012":"512","884":"238","434":"407","75":"272","865":"375","1260":"345","1449":"458","1469":"531","1358":"437","1435":"314","1271":"240","754":"446","243":"70","1250":"434","32":"363","444":"185","852":"42","406":"199","1371":"481","747":"218","777":"22","931":"516","629":"330","600":"406","711":"321","84":"17","853":"468","1484":"554","1444":"396","1275":"435","1328":"374","1013":"265","361":"133","804":"312","1473":"538","1227":"403","273":"11","1244":"380","1481":"549","490":"138","1421":"198","769":"480","1030":"224","91":"143","439":"320","751":"462","1282":"360","212":"410","1446":"412","1074":"505","755":"428","1228":"404","639":"383","1267":"394","1147":"33","370":"200","1252":"255","176":"32","966":"340","210":"441","1425":"232","1393":"63","738":"451","462":"397","992":"517","978":"357","1325":"124","1137":"220","1479":"546","133":"230","1379":"347","195":"491","1433":"310","445":"328","1206":"171","1412":"183","338":"425","1387":"28","1218":"264","142":"112","132":"234","1002":"493","1219":"280","1392":"62","232":"72","1148":"36","275":"322","621":"31","466":"513","73":"144","375":"377","538":"170","1448":"439","1409":"180","571":"274","844":"294","1457":"511","1184":"116","1406":"153","179":"247","413":"478","377":"262","475":"193","1447":"421","1050":"44","1420":"196","1474":"540","1302":"212","1092":"315","1000":"110","989":"502","398":"504","374":"420","418":"477","1229":"426","1287":"20","314":"520","1376":"286","1150":"45","42":"329","1049":"54","453":"14","1451":"463","1017":"454","53":"551","1395":"65","1407":"178","40":"129","1235":"444","298":"77","1440":"352","1112":"296","501":"476","1460":"521","537":"418","981":"358","1459":"515","129":"243","1113":"308","1454":"474","1236":"453","80":"202","970":"348","443":"332","1400":"73","530":"411","1415":"189","1111":"311","1204":"165","1174":"104","230":"367","246":"529","783":"447","1423":"209","1476":"543","1215":"249","1118":"391","220":"483","1122":"139","131":"148","778":"15","1246":"497","109":"542","1431":"283","31":"268","1410":"181","1466":"527","394":"135","898":"174","1188":"127","1179":"107","806":"423","339":"186","352":"14","194":"399","469":"422","1072":"339","178":"331","637":"486","240":"204","1036":"455","120":"259","1217":"263","161":"291","718":"334","733":"440","274":"395","918":"24","1205":"168","89":"194","1439":"337","414":"552","1477":"544","582":"1","260":"13","258":"162","474":"3","106":"365","349":"370","403":"52","11":"57","186":"101","1419":"195","1300":"211","197":"79","248":"398","35":"336","1414":"187","21":"369","568":"302","117":"499","974":"226","218":"203","464":"408","930":"210","139":"151","320":"80","478":"536","364":"508","1288":"386","1269":"335","78":"137","382":"270","782":"176","1195":"157","1304":"417","977":"350","810":"103","1146":"26","183":"510","112":"227","1176":"106","458":"424","550":"301","588":"465","969":"341","266":"282","252":"132","1171":"90","1385":"16","415":"244","1305":"21","1471":"533","1031":"147","1291":"387","254":"419","1253":"256","1004":"173","235":"242","441":"285","680":"257","1223":"344","922":"43","250":"134","138":"235","838":"6","742":"534","1200":"161","482":"130","185":"416","389":"214","1386":"23","470":"429","265":"275","1225":"229","1209":"219","365":"4","924":"89","1430":"281","1467":"528","638":"119","579":"145","1011":"401","1028":"266","919":"25","809":"267","1461":"522","1453":"471","1428":"252","1436":"317","1216":"250","1247":"498","227":"261","1232":"433","1445":"405","1368":"223","1254":"221","1438":"323","1289":"94","1422":"205","1245":"382","1426":"246"}', 1);
		$playerIds = explode(',', $_REQUEST['id']);
		foreach ( $data as $k => $v ) {
			if ( isset( $map[ $v->Id ] ) && in_array($map[ $v->Id ], $playerIds) ) {
				$arr[ $map[ $v->Id ] ] = array(
					'p' => $v->Cos,
					'n' => $v->Sel,
					'd' => $v->NTI,
					'c' => $v->Col == "G" ? $v->Min : '-'.$v->Min,
				);
			}
		}
		break;
	case 'CTC':
	default:
		$url = 'http://crackthecode.fiso.co.uk/blog/';
		$content = file_get_contents($url);
		foreach( explode(',', $_REQUEST['id']) as $playerId ) {
			$start = strpos( $content, 'fpl1415-player-history?id='.$playerId.'\'' )-9;
			$str = substr($content, $start, 200);
			$end = strpos($str, '</tr>')-5;
			$str = substr($str, 0, $end);
			$info = explode('</td><td>', $str);
			$arr[ $playerId ] = array(
				'p' => $info[3],
				'n' => str_replace(',', '', $info[4]),
				'd' => $info[5],
				'c' => $info[6],
			);
		}
		break;
}
echo json_encode( $arr );
exit();
